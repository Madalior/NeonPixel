<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeonPixel | Smart Gallery</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { --bg: #0a0a0a; --card: #141414; --accent: #00FFFF; --text: #fff; --text-dim: #888; }
        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Outfit', sans-serif; background: var(--bg); color: var(--text); overflow-x: hidden; }

        nav { position: fixed; top: 0; width: 100%; height: 70px; background: rgba(10,10,10,0.9); backdrop-filter: blur(10px); z-index: 100; display: flex; justify-content: space-between; align-items: center; padding: 0 5%; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .logo { font-size: 1.5rem; font-weight: 700; } .logo span { color: var(--accent); }
        .nav-tabs { display: flex; gap: 10px; }
        .tab-btn { background: transparent; border: 1px solid #333; color: var(--text-dim); padding: 5px 15px; border-radius: 20px; cursor: pointer; transition: 0.3s; }
        .tab-btn.active { background: var(--text); color: #000; font-weight: 700; border-color: var(--text); }

        .hero { padding-top: 100px; text-align: center; padding-bottom: 20px; }
        .device-switch { display: inline-flex; background: var(--card); padding: 5px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #333; }
        .dev-btn { padding: 10px 20px; background: transparent; border: none; color: var(--text-dim); cursor: pointer; border-radius: 8px; display: flex; gap: 8px; align-items: center; transition: 0.3s; }
        .dev-btn.active { background: var(--accent); color: #000; font-weight: 700; }

        /* CATEGORIES & SUBCATEGORIES */
        .cat-row { display: flex; gap: 10px; overflow-x: auto; padding: 10px 5%; scrollbar-width: none; justify-content: center; }
        .cat-chip { white-space: nowrap; padding: 8px 20px; border-radius: 30px; background: var(--card); border: 1px solid #333; color: var(--text-dim); cursor: pointer; transition: 0.3s; }
        .cat-chip.active { border-color: var(--accent); color: var(--accent); }
        
        .sub-cat-row { display: flex; gap: 8px; overflow-x: auto; padding: 5px 5%; justify-content: center; min-height: 40px; margin-bottom: 20px; opacity: 0; transition: 0.3s; transform: translateY(-10px); display: none; }
        .sub-cat-row.show { opacity: 1; transform: translateY(0); display: flex; }
        .sub-chip { font-size: 0.85rem; padding: 5px 15px; border-radius: 20px; background: rgba(255,255,255,0.05); cursor: pointer; border: 1px solid transparent; }
        .sub-chip:hover { background: rgba(255,255,255,0.1); }
        .sub-chip.active { background: var(--accent); color: #000; font-weight: 600; }

        .grid { column-count: 4; column-gap: 15px; padding: 0 5%; }
        @media(max-width: 1000px) { .grid { column-count: 2; } }
        @media(max-width: 600px) { .grid { column-count: 1; } }
        
        .card { break-inside: avoid; margin-bottom: 15px; border-radius: 10px; overflow: hidden; position: relative; cursor: pointer; background: #111; }
        .card img, .card video { width: 100%; display: block; }
        .overlay { position: absolute; bottom: 0; left: 0; width: 100%; padding: 15px; background: linear-gradient(transparent, rgba(0,0,0,0.9)); }
        .sub-tag { font-size: 0.7rem; background: var(--accent); color: #000; padding: 2px 8px; border-radius: 4px; font-weight: 700; text-transform: uppercase; }

        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 2000; display: none; justify-content: center; align-items: center; }
        .modal.active { display: flex; }
        .modal-content { max-width: 90%; max-height: 90%; text-align: center; }
        .modal-content img, .modal-content video { max-height: 80vh; max-width: 100%; border-radius: 10px; }
        .dl-btn { display: inline-block; margin-top: 20px; padding: 10px 30px; background: var(--accent); color: #000; text-decoration: none; border-radius: 50px; font-weight: 700; }
        .close { position: absolute; top: 20px; right: 20px; font-size: 2rem; color: #fff; cursor: pointer; }
    </style>
</head>
<body>

    <nav>
        <div class="logo">Neon<span>Pixel</span></div>
        <div class="nav-tabs">
            <button class="tab-btn active" onclick="setTab('wallpapers')">Photos</button>
            <button class="tab-btn" onclick="setTab('videos')">Loops</button>
        </div>
    </nav>

    <div class="hero">
        <div class="device-switch">
            <button class="dev-btn active" id="d-mobile" onclick="setDevice('mobile')"><i class="fa-solid fa-mobile"></i> Mobile</button>
            <button class="dev-btn" id="d-desktop" onclick="setDevice('desktop')"><i class="fa-solid fa-desktop"></i> Desktop</button>
        </div>
    </div>

    <div class="cat-row" id="mainCats"></div>
    
    <div class="sub-cat-row" id="subCats"></div>

    <div class="grid" id="grid"></div>

    <div class="modal" id="modal">
        <span class="close" onclick="closeModal()">&times;</span>
        <div class="modal-content">
            <div id="m-preview"></div>
            <a href="#" id="m-dl" class="dl-btn" download target="_blank">Download</a>
        </div>
    </div>

    <script>
        let data = { wallpapers: [], videos: [] };
        let state = { tab: 'wallpapers', device: 'mobile', cat: 'All', sub: 'All' };
        
        // Define known subcategories for the UI
        const SUB_MAP = {
            "Anime": ["All", "Naruto", "One Piece", "Dragon Ball", "Jujutsu Kaisen", "Demon Slayer", "Solo Leveling", "Ghibli"],
            "Cars": ["All", "JDM", "BMW", "Porsche", "Ferrari", "GTR", "Toyota", "Audi", "Drift"],
            "Gaming": ["All", "Valorant", "League of Legends", "Elden Ring", "Genshin Impact", "Minecraft", "Cyberpunk 2077", "GTA"],
            "Nature": ["All", "Forest", "Ocean", "Mountain", "Space", "Sunset", "Winter", "Rain"],
            "Cyberpunk": ["All", "Neon", "City", "Robot", "Future", "Glitch"],
            "Abstract": ["All", "Fluid", "Geometric", "Dark", "Light", "Minimal"]
        };
        const MAIN_CATS = ["All", ...Object.keys(SUB_MAP)];

        window.onload = async () => {
            renderCats();
            try {
                const [w, v] = await Promise.all([
                    fetch("data/cloud_wallpapers.json").then(r=>r.json()), 
                    fetch("data/videos.json").then(r=>r.json())
                ]);
                
                // Map data and assign "General" if subcategory is missing
                data.wallpapers = w.map(i => ({
                    ...i, 
                    subcategory: i.subcategory || "General", 
                    device: i.device || "mobile"
                }));
                data.videos = v.map(i => ({
                    ...i, 
                    subcategory: i.subcategory || "General", 
                    device: "mobile"
                }));
                render();
            } catch(e) { console.log(e); }
        };

        function render() {
            const grid = document.getElementById('grid');
            const source = state.tab === 'wallpapers' ? data.wallpapers : data.videos;
            
            const filtered = source.filter(item => {
                const devMatch = (state.tab === 'videos') ? true : (item.device === state.device);
                const catMatch = (state.cat === 'All') || (item.category === state.cat);
                // Smart Filter: If sub is "All", show everything in main cat. Else match specific sub.
                const subMatch = (state.sub === 'All') || (item.subcategory === state.sub);
                return devMatch && catMatch && subMatch;
            });

            if(!filtered.length) { grid.innerHTML = `<p style="text-align:center;width:100%;color:#888;">No results found.</p>`; return; }

            grid.innerHTML = filtered.map(item => `
                <div class="card fade-in" onclick='openModal(${JSON.stringify(item)})'>
                    ${item.type === 'image' 
                        ? `<img src="${item.src.replace('/upload/', '/upload/w_500,f_auto,q_auto/')}" loading="lazy">` 
                        : `<video src="${item.src}" muted loop onmouseover="this.play()" onmouseout="this.pause()"></video>`
                    }
                    <div class="overlay">
                        <span class="sub-tag">${item.subcategory}</span>
                    </div>
                </div>
            `).join('');
        }

        // --- UI LOGIC ---
        function renderCats() {
            const c = document.getElementById('mainCats');
            c.innerHTML = MAIN_CATS.map(cat => `
                <div class="cat-chip ${cat === state.cat ? 'active' : ''}" onclick="setCat('${cat}')">${cat}</div>
            `).join('');
            renderSubCats();
        }

        function renderSubCats() {
            const sc = document.getElementById('subCats');
            if (state.cat === 'All' || !SUB_MAP[state.cat]) {
                sc.className = "sub-cat-row"; // Hide if All or unknown
                return;
            }
            sc.className = "sub-cat-row show"; // Show
            sc.innerHTML = SUB_MAP[state.cat].map(sub => `
                <div class="sub-chip ${sub === state.sub ? 'active' : ''}" onclick="setSub('${sub}')">${sub}</div>
            `).join('');
        }

        function setTab(t) { 
            state.tab = t; 
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            render(); 
        }
        function setDevice(d) {
            state.device = d;
            document.getElementById('d-mobile').className = `dev-btn ${d==='mobile'?'active':''}`;
            document.getElementById('d-desktop').className = `dev-btn ${d==='desktop'?'active':''}`;
            render();
        }
        function setCat(c) { state.cat = c; state.sub = 'All'; renderCats(); render(); }
        function setSub(s) { state.sub = s; renderSubCats(); render(); }

        function openModal(item) {
            const m = document.getElementById('modal');
            const p = document.getElementById('m-preview');
            const d = document.getElementById('m-dl');
            p.innerHTML = item.type === 'image' ? `<img src="${item.src}">` : `<video src="${item.src}" controls autoplay loop></video>`;
            d.href = item.src;
            m.classList.add('active');
        }
        function closeModal() {
            document.getElementById('modal').classList.remove('active');
            document.getElementById('m-preview').innerHTML = '';
        }
        document.getElementById('modal').addEventListener('click', (e) => { if(e.target.id === 'modal') closeModal(); });

    </script>
</body>
</html>